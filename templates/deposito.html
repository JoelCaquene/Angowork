{% extends "base.html" %}
{% load static %}

{% block title %}Depósito Profissional - ANGOWORK{% endblock %}

{% block content %}
<div class="deposit-dashboard">
    {# HEADER #}
    <div class="premium-header">
        <h2 class="logo-angowork">CENTRAL DE DEPÓSITO</h2>
        <div class="security-tag"><i class="fas fa-user-shield"></i> Transação Segura</div>
    </div>

    {# STEPPER #}
    <div class="stepper-glass glass-effect">
        <div class="step-item">
            <div class="circle active" id="circle-1"><i class="fas fa-wallet"></i></div>
            <span class="step-label">Valor</span>
        </div>
        <div class="step-line"></div>
        <div class="step-item">
            <div class="circle" id="circle-2"><i class="fas fa-university"></i></div>
            <span class="step-label">Banco</span>
        </div>
        <div class="step-line"></div>
        <div class="step-item">
            <div class="circle" id="circle-3"><i class="fas fa-cloud-upload-alt"></i></div>
            <span class="step-label">Envio</span>
        </div>
    </div>

    {% if deposit_success %}
        <div class="success-screen glass-effect">
            <div class="success-character-box">
                <div class="character-icon">
                    <i class="fas fa-user-tie"></i>
                    <div class="paper-float"><i class="fas fa-file-invoice-dollar"></i></div>
                </div>
            </div>
            <h2 class="mt-10">Solicitação Enviada!</h2>
            <p>Seu comprovante está com nossos analistas. O saldo será creditado entre 5 a 30 minutos.</p>
            <a href="{% url 'menu' %}" class="btn-main mt-15">VOLTAR AO PAINEL</a>
        </div>
    {% else %}
        <form id="deposit-form" method="post" enctype="multipart/form-data">
            {% csrf_token %}
            <input type="hidden" name="amount" id="id_amount">
            <input type="hidden" name="payment_method" value="bank">
            <input type="hidden" name="selected_bank" id="id_selected_bank">

            {# PASSO 1 #}
            <div id="step-1" class="step-content">
                <div class="info-card glass-effect">
                    <label class="label-premium">VALOR DO PLANO</label>
                    <div class="amount-grid">
                        {% for amount in level_deposits_list %}
                        <div class="amount-sq" data-value="{{ amount }}">
                            <span class="currency">KZ</span>
                            <span class="val">{{ amount }}</span>
                        </div>
                        {% endfor %}
                    </div>
                    
                    <div class="manual-input-box">
                        <label>Ou digite outro valor:</label>
                        <input type="number" id="manual-amount" placeholder="Valor customizado" class="glass-input">
                    </div>
                </div>

                <div class="rules-card glass-effect">
                    <h4><i class="fas fa-info-circle"></i> REGRAS</h4>
                    <ul>
                        <li><i class="fas fa-check-circle"></i> Dias Segunda a Sábado, das 08:15 até 20:30 Minutos</li>
                        <li><i class="fas fa-check-circle"></i> Use apenas IBANs listados aqui.</li>
                        <li><i class="fas fa-check-circle"></i> Comprovantes falsos banem a conta.</li>
                        <li><i class="fas fa-check-circle"></i> Não use bancos diferentes, não aprovamos nem é aceite.</li>
                        <li><i class="fas fa-check-circle"></i> Não duplica ou envia o seu comprovativo a outros, envie apenas dentro da plataforma.</li>
                    </ul>
                </div>
                
                <button type="button" class="btn-main" id="to-step-2" disabled>PRÓXIMO PASSO <i class="fas fa-chevron-right"></i></button>
            </div>

            {# PASSO 2 #}
            <div id="step-2" class="step-content" style="display: none;">
                <div class="glass-effect">
                    <h4 class="step-title">DESTINO DO PAGAMENTO</h4>
                    <div class="bank-selection-grid">
                        {% for bank in platform_bank_details %}
                        <div class="bank-card" data-bank-id="{{ forloop.counter }}">
                            <i class="fas fa-landmark"></i>
                            <span>{{ bank.bank_name }}</span>
                        </div>
                        {% endfor %}
                    </div>
                </div>

                <div id="bank-data-display" style="display: none;" class="glass-effect mt-15">
                    {% for bank in platform_bank_details %}
                    <div id="details-{{ forloop.counter }}" class="bank-details-info" style="display: none;">
                        <div class="copy-group">
                            <label>TITULAR</label>
                            <input type="text" value="{{ bank.account_holder_name }}" readonly class="copy-input-plain">
                        </div>
                        <div class="copy-group">
                            <label>IBAN</label>
                            <div class="copy-row">
                                <input type="text" value="{{ bank.IBAN }}" readonly id="iban-{{ forloop.counter }}">
                                <button type="button" onclick="copyText('iban-{{ forloop.counter }}')"><i class="far fa-copy"></i></button>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                    <div class="final-amount-badge">
                        ENVIAR: <span id="summary-amount">0</span> KZ
                    </div>
                </div>

                <button type="button" class="btn-main" id="to-step-3" disabled>JÁ FIZ O PAGAMENTO <i class="fas fa-check"></i></button>
            </div>

            {# PASSO 3 #}
            <div id="step-3" class="step-content" style="display: none;">
                <div class="glass-effect text-center">
                    <div class="upload-area" onclick="document.getElementById('file-upload').click()">
                        <i class="fas fa-file-import"></i>
                        <span id="file-name">ANEXAR COMPROVANTE</span>
                        <input type="file" name="proof_of_payment" id="file-upload" hidden accept="image/*">
                    </div>

                    <div class="input-group-premium mt-15">
                        <label>NOME NO COMPROVANTE</label>
                        <input type="text" name="payer_name" id="id_payer_name" placeholder="Nome do depositante" class="glass-input-dark">
                    </div>
                </div>

                <button type="submit" class="btn-confirm mt-15">CONFIRMAR ENVIO <i class="fas fa-paper-plane"></i></button>
            </div>
        </form>
    {% endif %}
</div>

<style>
    /* RESET ANTI-ROLAGEM */
    html, body { overflow-x: hidden; width: 100%; position: relative; margin: 0; padding: 0; }
    body { background: linear-gradient(rgba(0,0,0,0.85), rgba(0,0,0,0.85)), url("{% static 'background_cad.jpg' %}") no-repeat center center fixed; background-size: cover; color: white; font-family: 'Segoe UI', sans-serif; }
    
    .deposit-dashboard { width: 100%; max-width: 480px; margin: 0 auto; padding: 15px; box-sizing: border-box; }
    .glass-effect { background: rgba(255, 255, 255, 0.08); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.1); border-radius: 20px; padding: 15px; margin-bottom: 12px; box-sizing: border-box; }
    
    /* PREVENT OVERFLOW ON GRID */
    .amount-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 6px; margin: 15px 0; width: 100%; }
    .amount-sq { background: rgba(0,0,0,0.4); border: 1px solid rgba(255,255,255,0.1); border-radius: 10px; padding: 8px 2px; text-align: center; cursor: pointer; transition: 0.2s; overflow: hidden; }
    .amount-sq .val { font-size: 11px; font-weight: 800; display: block; }
    .amount-sq .currency { font-size: 8px; opacity: 0.6; }
    .amount-sq.active { background: #0056b3; border-color: #00a2ff; transform: scale(1.05); }

    /* STEPPER RESPONSIVO */
    .stepper-glass { display: flex; align-items: center; justify-content: space-between; padding: 12px; }
    .step-item { display: flex; flex-direction: column; align-items: center; flex: 1; }
    .circle { width: 32px; height: 32px; border-radius: 10px; background: rgba(255,255,255,0.1); display: flex; align-items: center; justify-content: center; font-size: 14px; }
    .circle.active { background: #0056b3; box-shadow: 0 0 15px rgba(0,86,179,0.5); }
    .circle.checked { background: #2e7d32; }
    .step-line { width: 30px; height: 2px; background: rgba(255,255,255,0.1); margin-top: -15px; }
    .step-label { font-size: 9px; margin-top: 6px; text-transform: uppercase; font-weight: bold; }

    /* SUCCESS SCREEN CENTRALIZED */
    .success-screen { text-align: center; padding: 40px 20px; }
    .success-character-box { position: relative; width: 100px; margin: 0 auto; height: 100px; background: rgba(0,255,136,0.1); border-radius: 50%; display: flex; align-items: center; justify-content: center; }
    .character-icon { font-size: 50px; color: #00ff88; position: relative; }
    .paper-float { position: absolute; top: -5px; right: -15px; font-size: 25px; color: #fff; animation: float 2s infinite ease-in-out; }
    @keyframes float { 0%, 100% { transform: translateY(0) rotate(0deg); } 50% { transform: translateY(-15px) rotate(20deg); } }

    /* INPUTS & BUTTONS */
    .glass-input, .glass-input-dark { width: 100%; box-sizing: border-box; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); padding: 12px; border-radius: 10px; color: #fff; }
    .btn-main { width: 100%; padding: 16px; border-radius: 12px; border: none; background: #0056b3; color: white; font-weight: bold; font-size: 14px; cursor: pointer; }
    .btn-confirm { width: 100%; padding: 18px; border-radius: 12px; border: none; background: #2e7d32; color: white; font-weight: 900; box-shadow: 0 4px 15px rgba(0,0,0,0.3); }
    .btn-main:disabled { opacity: 0.3; }

    .bank-selection-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
    .bank-card { background: rgba(255,255,255,0.05); padding: 12px; border-radius: 12px; text-align: center; border: 1px solid rgba(255,255,255,0.1); }
    .bank-card.active { border-color: #00a2ff; background: rgba(0,86,179,0.2); }
    
    .copy-row { display: flex; gap: 5px; margin-top: 5px; }
    .copy-row input { flex: 1; background: rgba(0,0,0,0.5); border: 1px solid rgba(255,255,255,0.1); padding: 10px; border-radius: 8px; color: #00ff88; font-family: monospace; font-size: 12px; }
    .copy-row button { background: #0056b3; border: none; color: white; padding: 10px; border-radius: 8px; }

    .upload-area { border: 2px dashed rgba(255,255,255,0.2); border-radius: 15px; padding: 25px; cursor: pointer; }
    .upload-area i { font-size: 30px; display: block; margin-bottom: 10px; color: #00a2ff; }
    
    .final-amount-badge { background: #2e7d32; padding: 12px; border-radius: 10px; text-align: center; font-weight: bold; margin-top: 15px; }
    .text-center { text-align: center; }
    .mt-10 { margin-top: 10px; } .mt-15 { margin-top: 15px; }
</style>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const amountHidden = document.getElementById('id_amount');
        const manualInput = document.getElementById('manual-amount');
        const next1 = document.getElementById('to-step-2');
        const next2 = document.getElementById('to-step-3');

        document.querySelectorAll('.amount-sq').forEach(sq => {
            sq.addEventListener('click', () => {
                document.querySelectorAll('.amount-sq').forEach(s => s.classList.remove('active'));
                sq.classList.add('active');
                manualInput.value = ""; 
                amountHidden.value = sq.dataset.value;
                next1.disabled = false;
            });
        });

        manualInput.addEventListener('input', (e) => {
            document.querySelectorAll('.amount-sq').forEach(s => s.classList.remove('active'));
            amountHidden.value = e.target.value;
            next1.disabled = (e.target.value <= 0);
        });

        next1.addEventListener('click', () => {
            document.getElementById('summary-amount').innerText = amountHidden.value;
            goToStep(2);
        });

        document.querySelectorAll('.bank-card').forEach(card => {
            card.addEventListener('click', () => {
                document.querySelectorAll('.bank-card').forEach(c => c.classList.remove('active'));
                card.classList.add('active');
                const bankId = card.dataset.bankId;
                document.getElementById('id_selected_bank').value = bankId;
                document.getElementById('bank-data-display').style.display = 'block';
                document.querySelectorAll('.bank-details-info').forEach(d => d.style.display = 'none');
                document.getElementById('details-' + bankId).style.display = 'block';
                next2.disabled = false;
            });
        });

        next2.addEventListener('click', () => goToStep(3));

        function goToStep(step) {
            document.querySelectorAll('.step-content').forEach(el => el.style.display = 'none');
            document.getElementById('step-' + step).style.display = 'block';
            if(step == 2) {
                document.getElementById('circle-1').classList.replace('active', 'checked');
                document.getElementById('circle-1').innerHTML = '<i class="fas fa-check"></i>';
                document.getElementById('circle-2').classList.add('active');
            }
            if(step == 3) {
                document.getElementById('circle-2').classList.replace('active', 'checked');
                document.getElementById('circle-2').innerHTML = '<i class="fas fa-check"></i>';
                document.getElementById('circle-3').classList.add('active');
            }
            window.scrollTo(0,0);
        }

        document.getElementById('file-upload').addEventListener('change', function() {
            const name = this.files[0] ? this.files[0].name : "ANEXAR COMPROVANTE";
            document.getElementById('file-name').innerText = name;
        });
    });

    function copyText(id) {
        const input = document.getElementById(id);
        input.select();
        navigator.clipboard.writeText(input.value);
        alert("Copiado!");
    }
</script>
{% endblock %}
