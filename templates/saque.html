{% extends "base.html" %}
{% load static %}

{% block title %}Levantamento de Salário - ANGOWORK{% endblock %}

{% block content %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

<div class="withdraw-viewport">
    <div class="withdraw-dashboard">
        
        {# BOTÃO VOLTAR E TÍTULO #}
        <div class="top-nav-withdraw">
            <a href="javascript:history.back()" class="btn-back-glass">
                <i class="fas fa-arrow-left"></i>
            </a>
            <span class="nav-title">CENTRO/SAQUÊ</span>
        </div>
        
        {# HEADER COM SALDO E BOTÃO HISTÓRICO #}
        <div class="premium-header-withdraw">
            <div class="balance-display-glass">
                <span class="label">SALDO</span>
                <span class="value">{{ request.user.available_balance|default:"0" }} <small>KZ</small></span>
            </div>
            <button type="button" class="history-trigger" onclick="toggleHistory()">
                <i class="fas fa-history"></i> HISTÓRICO
            </button>
        </div>

        {# SEÇÃO DE HISTÓRICO (MODAL) #}
        <div id="history-section" class="history-overlay glass-effect" style="display: none;">
            <div class="history-header">
                <h4>MEUS LEVANTAMENTOS</h4>
                <button onclick="toggleHistory()" class="close-history">&times;</button>
            </div>
            <div class="history-list">
                {% if withdrawal_records %}
                    {% for w in withdrawal_records %}
                    <div class="history-card {% if w.status == 'Aprovado' %}card-approved{% elif w.status == 'Pendente' %}card-pending{% else %}card-rejected{% endif %}">
                        <div class="card-main">
                            <span class="amount">{{ w.amount }} KZ</span>
                            <span class="status-badge">{{ w.status|upper }}</span>
                        </div>
                        <div class="card-details">
                            <p><i class="far fa-clock"></i> Solicitação: {{ w.created_at|date:"H:i - d/m" }}</p>
                            {% if w.status == 'Aprovado' %}
                                <p><i class="fas fa-check-double"></i> Aprovação: {{ w.updated_at|date:"H:i - d/m" }}</p>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <p class="empty-msg">Nenhum registro encontrado.</p>
                {% endif %}
            </div>
        </div>

        {# CONTEÚDO PRINCIPAL #}
        <div class="main-withdraw-content">

            {% if messages %}
                {% for message in messages %}
                    <div class="msg-alert {{ message.tags }}">{{ message }}</div>
                {% endfor %}
            {% endif %}

            {# LÓGICA DE INTERFACE BASEADA NO ESTADO DO SISTEMA #}
            {% if is_sunday %}
                {# MENSAGEM DE DOMINGO #}
                <div class="glass-effect p-form error-time">
                    <i class="fas fa-calendar-times" style="font-size: 3.5rem; color: #ffbb33; margin-bottom: 15px;"></i>
                    <h3 style="color: #ffbb33;">SISTEMA FECHADO</h3>
                    <p style="font-weight: bold;">Hoje é feriado, saque é só amanhã.</p>
                </div>

            {% elif is_time_to_withdraw %}
                {# SISTEMA ABERTO (09:00 - 17:00 / SEG A SAB) #}
                <form method="post" id="form-saque">
                    {% csrf_token %}
                    <input type="hidden" name="withdrawal_method" value="BANCO"> 
                    <div class="glass-effect p-form">
                        <div class="amount-input-central">
                            <label>VALOR DO SAQUE</label>
                            <div class="input-container">
                                <span class="currency">KZ</span>
                                <input type="number" name="amount" id="id_amount" readonly required placeholder="0">
                            </div>
                            <div id="tax-info" class="tax-info-box" style="display:none;">
                                <small>Taxa administrativa (15%): - <span id="tax-value">0</span> KZ</small><br>
                                <strong>Receberá líquido: <span id="net-value">0</span> KZ</strong>
                            </div>
                        </div>

                        <div class="quick-values-grid">
                            <button type="button" class="value-pill" onclick="setAmount(2500)">2.500</button>
                            <button type="button" class="value-pill" onclick="setAmount(5000)">5.000</button>
                            <button type="button" class="value-pill" onclick="setAmount(17000)">17.000</button>
                            <button type="button" class="value-pill" onclick="setAmount(30000)">30.000</button>
                            <button type="button" class="value-pill" onclick="setAmount(50000)">50.000</button>
                            <button type="button" class="value-pill" onclick="setAmount(100000)">100.000</button>
                            <button type="button" class="value-pill" onclick="setAmount(200000)">200.000</button>
                            <button type="button" class="value-pill" onclick="setAmount(300000)">300.000</button>
                            <button type="button" class="value-pill" onclick="setAmount(400000)">400.000</button>
                            <button type="button" class="value-pill" onclick="setAmount(500000)">500.000</button>
                            <button type="button" class="value-pill" onclick="setAmount(600000)">600.000</button>
                            <button type="button" class="value-pill" onclick="setAmount(700000)">700.000</button>
                        </div>
                    </div>

                    <button type="submit" class="btn-confirm-withdraw">
                        SOLICITAR <i class="fas fa-check-circle"></i>
                    </button>
                </form>
            {% else %}
                {# MENSAGEM FORA DO HORÁRIO #}
                <div class="glass-effect p-form error-time">
                    <i class="fas fa-clock" style="font-size: 3rem; color: #ff4444; margin-bottom: 15px;"></i>
                    <h3>SISTEMA INDISPONÍVEL</h3>
                    <p>Horário de levantamentos: <strong>Segunda a Sábado, das 09:00 às 17:00</strong>.</p>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<style>
    /* RESET E LAYOUT */
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    html, body { margin: 0; padding: 0; width: 100%; overflow-x: hidden; background: linear-gradient(rgba(0,0,0,0.85), rgba(0,0,0,0.85)), url("{% static 'background_cad.jpg' %}") no-repeat center center fixed; background-size: cover; color: white; font-family: 'Segoe UI', sans-serif; }

    .withdraw-viewport { width: 100%; display: flex; justify-content: center; min-height: 100vh; }
    .withdraw-dashboard { width: 100%; max-width: 450px; padding: 15px; }

    /* BOTÃO VOLTAR */
    .top-nav-withdraw { display: flex; align-items: center; margin-bottom: 20px; padding: 5px 0; }
    .btn-back-glass { width: 40px; height: 40px; background: rgba(255,255,255,0.1); border-radius: 12px; display: flex; align-items: center; justify-content: center; color: white; text-decoration: none; border: 1px solid rgba(255,255,255,0.1); }
    .nav-title { margin-left: 15px; font-weight: 800; font-size: 1.1rem; letter-spacing: 1px; color: #00a2ff; }

    .glass-effect { background: rgba(255, 255, 255, 0.07); backdrop-filter: blur(15px); border: 1px solid rgba(255,255,255,0.1); border-radius: 20px; }
    .p-form { padding: 30px 15px; text-align: center; }

    /* HEADER */
    .premium-header-withdraw { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
    .balance-display-glass { background: rgba(0, 162, 255, 0.2); padding: 10px 15px; border-radius: 12px; border-left: 4px solid #00a2ff; }
    .balance-display-glass .label { display: block; font-size: 9px; opacity: 0.7; letter-spacing: 1px; }
    .balance-display-glass .value { font-size: 1.1rem; font-weight: 800; }

    .history-trigger { background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: white; padding: 8px 12px; border-radius: 8px; font-size: 11px; font-weight: bold; cursor: pointer; }

    /* HISTÓRICO MODAL */
    .history-overlay { position: fixed; top: 12%; left: 5%; right: 5%; bottom: 10%; z-index: 999; display: flex; flex-direction: column; padding: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.8); }
    .history-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 10px; }
    .close-history { background: #ff4444; border: none; color: white; width: 28px; height: 28px; border-radius: 50%; cursor: pointer; }
    .history-list { flex: 1; overflow-y: auto; }

    /* CARDS HISTÓRICO */
    .history-card { border-radius: 12px; padding: 12px; margin-bottom: 10px; border-left: 5px solid; text-align: left; }
    .card-approved { background: rgba(46, 125, 50, 0.3); border-color: #2e7d32; }
    .card-pending { background: rgba(198, 40, 40, 0.3); border-color: #c62828; }
    .card-rejected { background: rgba(80, 80, 80, 0.3); border-color: #555; }
    .card-main { display: flex; justify-content: space-between; align-items: center; font-weight: bold; }
    .status-badge { font-size: 9px; padding: 3px 7px; background: rgba(0,0,0,0.3); border-radius: 4px; }
    .card-details { font-size: 10px; opacity: 0.8; margin-top: 5px; }

    /* TAXA BOX */
    .tax-info-box { margin-top: 15px; padding: 10px; background: rgba(255, 166, 0, 0.1); border-radius: 10px; border: 1px dashed orange; color: #ffcc00; font-size: 12px; }

    /* FORMULÁRIO */
    .input-container { display: flex; align-items: center; justify-content: center; border-bottom: 2px solid #00a2ff; max-width: 180px; margin: 0 auto; }
    .input-container input { background: transparent; border: none; color: white; font-size: 1.8rem; font-weight: 800; text-align: center; width: 100%; outline: none; }
    .quick-values-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-top: 20px; }
    .value-pill { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); color: white; padding: 12px 2px; border-radius: 10px; font-size: 10px; font-weight: bold; cursor: pointer; transition: 0.2s; }
    .value-pill:active { background: #00a2ff; transform: scale(0.95); }
    
    .btn-confirm-withdraw { width: 100%; margin-top: 20px; padding: 18px; border-radius: 15px; border: none; background: linear-gradient(to right, #0056b3, #00a2ff); color: white; font-weight: bold; cursor: pointer; box-shadow: 0 5px 15px rgba(0, 162, 255, 0.3); }
    
    .msg-alert { padding: 12px; border-radius: 8px; margin-bottom: 15px; font-size: 13px; text-align: center; font-weight: 600; }
    .msg-alert.error { background: rgba(255,0,0,0.2); color: #ffcccc; border: 1px solid rgba(255,0,0,0.3); }
    .msg-alert.success { background: rgba(0,255,0,0.2); color: #ccffcc; border: 1px solid rgba(0,255,0,0.3); }
</style>

<script>
    function setAmount(val) {
        const input = document.getElementById('id_amount');
        input.value = val;
        
        // CÁLCULO VISUAL DA TAXA DE 15%
        const taxBox = document.getElementById('tax-info');
        const taxDisplay = document.getElementById('tax-value');
        const netDisplay = document.getElementById('net-value');
        
        const tax = (val * 0.15).toFixed(0);
        const net = (val - tax).toFixed(0);
        
        taxDisplay.innerText = Number(tax).toLocaleString('pt-PT');
        netDisplay.innerText = Number(net).toLocaleString('pt-PT');
        taxBox.style.display = 'block';

        const container = document.querySelector('.input-container');
        container.style.borderColor = '#00ff88';
        setTimeout(() => container.style.borderColor = '#00a2ff', 300);
    }

    function toggleHistory() {
        const hist = document.getElementById('history-section');
        hist.style.display = (hist.style.display === 'none') ? 'flex' : 'none';
    }
</script>
{% endblock %}
