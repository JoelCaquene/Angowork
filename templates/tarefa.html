{% extends "base.html" %}
{% load static %}

{% block title %}ANGOWORK - Centro de Avaliações{% endblock %}

{% block content %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">

<div class="work-wrapper" style="background: url('{% static 'images/bg-work.jpg' %}') no-repeat center center fixed; background-size: cover;">
    <div class="glass-overlay"></div>
    
    <div class="work-container">
        
        {# NOVO HEADER ESTILIZADO #}
        <div class="header-premium">
            <div class="brand-group">
                <div class="logo-circle">AW</div>
                <div class="brand-text">
                    <h1>ANGOWORK</h1>
                    <p><i class="fa-solid fa-circle-check"></i> Parceiro Oficial de Marcas</p>
                </div>
            </div>
            <div class="badge-status {% if is_estagiario %}is-free{% endif %}">
                {% if is_estagiario %}ESTAGIÁRIO{% else %}VIP GOLD{% endif %}
            </div>
        </div>

        {# CONTEÚDO PRINCIPAL #}
        <div class="content-body">
            
            {# SEÇÃO 1: SELEÇÃO DE EMPRESAS (SLIDE) #}
            <div id="section-select" class="view-section">
                <div class="task-info-card">
                    <p>Escolha uma empresa para avaliar hoje e receba seu bônus.</p>
                    {% if is_estagiario %}
                    <div class="mini-alert">
                        Ganho disponível: <strong>450 KZ</strong>
                    </div>
                    {% endif %}
                </div>

                <div class="company-slider-container">
                    {% if is_sunday %}
                        <div class="sunday-card">
                            <i class="fa-solid fa-mug-hot"></i>
                            <h3>Domingo de Descanso</h3>
                            <p>Nossos servidores estão em manutenção. Voltamos segunda-feira!</p>
                        </div>
                    {% else %}
                        <div id="company-wrapper" class="company-wrapper">
                            {% for company in companies %}
                            <div class="company-card-premium" data-index="{{ forloop.counter0 }}" style="display: none;">
                                <div class="comp-icon-box">
                                    <i class="fa-solid {{ company.icon }}"></i>
                                </div>
                                <div class="comp-details">
                                    <h3>{{ company.name }}</h3>
                                    <span class="category">{{ company.category }}</span>
                                    <p class="description">Empresa líder no setor, com mais de 10 anos de excelência em Angola.</p>
                                </div>
                                <button class="btn-start-eval">Avaliar Agora</button>
                            </div>
                            {% endfor %}
                        </div>

                        <div class="slider-controls">
                            <button id="next-btn" class="btn-next">Próxima Empresa <i class="fa-solid fa-arrow-right"></i></button>
                        </div>
                    {% endif %}
                </div>
            </div>

            {# SEÇÃO 2: AVALIAÇÃO (GLASS TERMINAL) #}
            <div id="section-rate" class="view-section" style="display: none;">
                <div class="rating-box-glass">
                    <h2 id="eval-name">Avaliação</h2>
                    <p>Selecione o nível de satisfação:</p>
                    
                    <div class="star-rating-v2">
                        <i class="fa-solid fa-star star-btn" data-value="1"></i>
                        <i class="fa-solid fa-star star-btn" data-value="2"></i>
                        <i class="fa-solid fa-star star-btn" data-value="3"></i>
                        <i class="fa-solid fa-star star-btn" data-value="4"></i>
                        <i class="fa-solid fa-star star-btn" data-value="5"></i>
                    </div>

                    <div id="load-box" style="display: none;">
                        <div class="custom-loader"></div>
                        <p>Sincronizando dados com o servidor...</p>
                    </div>

                    <button id="final-submit" class="btn-confirm-eval" disabled>CONFIRMAR AVALIAÇÃO</button>
                </div>
            </div>

            {# SEÇÃO 3: FINALIZADO (BONECO DANÇANDO) #}
            <div id="section-done" class="view-section" style="display: none;">
                <div class="success-screen">
                    <img src="{% static 'images/done-anim.gif' %}" alt="Sucesso" class="dance-anim">
                    <h2>Excelente Trabalho!</h2>
                    <p>Sua avaliação foi processada com sucesso. O saldo já está na sua carteira.</p>
                    <a href="{% url 'home' %}" class="btn-back">Voltar ao Painel</a>
                </div>
            </div>

        </div>

        {# CARD DE PUBLICIDADE PREMIUM #}
        <div class="ads-card-premium">
            <div class="ad-label">PUBLICIDADE</div>
            <img src="{% static 'images/ad-premium.jpg' %}" alt="Ads">
            <div class="ad-info">
                <span>Anuncie aqui sua marca para milhares de usuários.</span>
            </div>
        </div>

    </div>
</div>

<style>
    /* VARIÁVEIS E BASE */
    :root {
        --glass: rgba(255, 255, 255, 0.15);
        --glass-border: rgba(255, 255, 255, 0.3);
        --gold: #ffcc00;
        --success: #00ff88;
    }

    .work-wrapper { min-height: 100vh; position: relative; display: flex; justify-content: center; padding: 20px 0; }
    .glass-overlay { position: absolute; top:0; left:0; width: 100%; height: 100%; background: rgba(0, 15, 30, 0.7); backdrop-filter: blur(8px); z-index: 1; }
    .work-container { position: relative; z-index: 2; width: 95%; max-width: 450px; display: flex; flex-direction: column; gap: 20px; }

    /* HEADER */
    .header-premium { background: var(--glass); border: 1px solid var(--glass-border); padding: 20px; border-radius: 20px; display: flex; justify-content: space-between; align-items: center; }
    .logo-circle { width: 45px; height: 45px; background: white; color: #003366; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 900; box-shadow: 0 0 15px rgba(255,255,255,0.3); }
    .brand-text h1 { color: white; font-size: 18px; margin: 0; }
    .brand-text p { color: var(--gold); font-size: 10px; margin: 0; text-transform: uppercase; }
    .badge-status { background: var(--success); color: #003366; padding: 5px 12px; border-radius: 10px; font-size: 11px; font-weight: 800; }
    .badge-status.is-free { background: var(--gold); }

    /* TASK INFO & CARDS */
    .task-info-card { text-align: center; color: white; font-size: 13px; margin-bottom: 20px; }
    .mini-alert { background: rgba(255,204,0,0.2); border: 1px solid var(--gold); display: inline-block; padding: 5px 15px; border-radius: 15px; margin-top: 10px; }

    .company-card-premium { background: white; border-radius: 25px; padding: 25px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.3); animation: slideIn 0.5s ease; margin-bottom: 15px; }
    .comp-icon-box { width: 70px; height: 70px; background: #f0f4f8; border-radius: 20px; display: flex; align-items: center; justify-content: center; margin: 0 auto 15px; font-size: 30px; color: #003366; }
    .comp-details h3 { margin: 0; color: #333; }
    .comp-details .category { color: #888; font-size: 12px; }
    .comp-details .description { font-size: 12px; color: #666; margin: 15px 0; line-height: 1.4; }
    .btn-start-eval { width: 100%; background: #003366; color: white; border: none; padding: 12px; border-radius: 15px; font-weight: 700; cursor: pointer; transition: 0.3s; }

    .slider-controls { display: flex; justify-content: center; margin-top: 10px; }
    .btn-next { background: var(--glass); border: 1px solid var(--glass-border); color: white; padding: 10px 20px; border-radius: 30px; font-size: 13px; cursor: pointer; }

    /* RATING GLASS */
    .rating-box-glass { background: var(--glass); border: 1px solid var(--glass-border); padding: 40px 20px; border-radius: 30px; text-align: center; color: white; }
    .star-rating-v2 { margin: 25px 0; font-size: 35px; color: rgba(255,255,255,0.2); }
    .star-rating-v2 i.active { color: var(--gold); text-shadow: 0 0 15px var(--gold); }
    .btn-confirm-eval { width: 100%; padding: 15px; border-radius: 15px; border: none; background: grey; color: white; font-weight: 700; }
    .btn-confirm-eval.ready { background: var(--success); color: #003366; cursor: pointer; }

    /* SUCCESS SCREEN */
    .success-screen { text-align: center; color: white; }
    .dance-anim { width: 180px; margin-bottom: 20px; }
    .btn-back { display: inline-block; margin-top: 20px; color: var(--gold); text-decoration: none; border: 1px solid var(--gold); padding: 10px 25px; border-radius: 20px; }

    /* ADS */
    .ads-card-premium { background: var(--glass); border-radius: 20px; overflow: hidden; border: 1px solid var(--glass-border); }
    .ad-label { font-size: 9px; color: white; opacity: 0.5; padding: 5px 15px; }
    .ads-card-premium img { width: 100%; height: 120px; object-fit: cover; }
    .ad-info { padding: 10px; color: white; font-size: 10px; text-align: center; }

    /* LOADER */
    .custom-loader { width: 40px; height: 40px; border: 4px solid var(--glass-border); border-top-color: var(--success); border-radius: 50%; animation: spin 1s linear infinite; margin: 20px auto; }
    @keyframes spin { to { transform: rotate(360deg); } }
    @keyframes slideIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
</style>

<script>
document.addEventListener("DOMContentLoaded", function() {
    let currentIndex = 0;
    const cards = document.querySelectorAll('.company-card-premium');
    const totalCompanies = cards.length;

    function updateSlider() {
        cards.forEach(card => card.style.display = 'none');
        // Exibe 2 por vez (ou 1 se for o último)
        if(cards[currentIndex]) cards[currentIndex].style.display = 'block';
        if(cards[currentIndex + 1]) cards[currentIndex + 1].style.display = 'block';
    }

    document.getElementById('next-btn').addEventListener('click', () => {
        currentIndex += 2;
        if (currentIndex >= totalCompanies) currentIndex = 0;
        updateSlider();
    });

    // Inicializa o slider
    updateSlider();

    const btnEvals = document.querySelectorAll('.btn-start-eval');
    const starBtns = document.querySelectorAll('.star-btn');
    const finalSubmit = document.getElementById('final-submit');
    const sectionSelect = document.getElementById('section-select');
    const sectionRate = document.getElementById('section-rate');
    const sectionDone = document.getElementById('section-done');
    const evalName = document.getElementById('eval-name');

    if ({{ tasks_completed_today|default:0 }} >= 1) {
        showSection('done');
    }

    btnEvals.forEach(btn => {
        btn.addEventListener('click', function() {
            const company = btn.parentElement.querySelector('h3').innerText;
            evalName.innerText = company;
            showSection('rate');
        });
    });

    starBtns.forEach(star => {
        star.addEventListener('click', function() {
            const val = this.getAttribute('data-value');
            starBtns.forEach(s => {
                s.classList.remove('active');
                if (s.getAttribute('data-value') <= val) s.classList.add('active');
            });
            finalSubmit.disabled = false;
            finalSubmit.classList.add('ready');
        });
    });

    finalSubmit.addEventListener('click', function() {
        this.style.display = 'none';
        document.getElementById('load-box').style.display = 'block';

        fetch("{% url 'process_task' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            }
        })
        .then(response => response.json())
        .then(data => {
            setTimeout(() => {
                if (data.success) {
                    showSection('done');
                } else {
                    alert(data.message);
                    location.reload();
                }
            }, 2000);
        });
    });

    function showSection(type) {
        sectionSelect.style.display = 'none';
        sectionRate.style.display = 'none';
        sectionDone.style.display = 'none';
        if (type === 'rate') sectionRate.style.display = 'block';
        else if (type === 'done') sectionDone.style.display = 'block';
        else sectionSelect.style.display = 'block';
    }
});
</script>
{% endblock %}
